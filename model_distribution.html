<!doctype html>
<html class="no-js" lang="en" data-content_root="">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Query assignment (poppunk_assign)" href="query_assignment.html" /><link rel="prev" title="Fitting new models (--fit-model)" href="model_fitting.html" />

    <!-- Generated with Sphinx 7.1.2 and Furo 2023.09.10 -->
        <title>Distributing PopPUNK models - PopPUNK 2.6.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">PopPUNK 2.6.2 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="_static/poppunk_v2.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">PopPUNK 2.6.2 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">PopPUNK documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="sketching.html">Sketching (<code class="docutils literal notranslate"><span class="pre">--create-db</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="qc.html">Data quality control (<code class="docutils literal notranslate"><span class="pre">--qc-db</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_fitting.html">Fitting new models (<code class="docutils literal notranslate"><span class="pre">--fit-model</span></code>)</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Distributing PopPUNK models</a></li>
<li class="toctree-l1"><a class="reference internal" href="query_assignment.html">Query assignment (<code class="docutils literal notranslate"><span class="pre">poppunk_assign</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualisation.html">Creating visualisations</a></li>
<li class="toctree-l1"><a class="reference internal" href="mst.html">Minimum spanning trees</a></li>
<li class="toctree-l1"><a class="reference internal" href="subclustering.html">Subclustering with PopPIPE</a></li>
<li class="toctree-l1"><a class="reference internal" href="gpu.html">Using GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="scripts.html">Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="poppunk_iterate.html">Iterative PopPUNK</a></li>
<li class="toctree-l1"><a class="reference internal" href="citing.html">Citing PopPUNK</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">Reference documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="miscellaneous.html">Miscellaneous</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="distributing-poppunk-models">
<h1>Distributing PopPUNK models<a class="headerlink" href="#distributing-poppunk-models" title="Permalink to this heading">#</a></h1>
<p>If you have fitted a model yourself, you may be interested in distributing it so that
others can use it for your species. This will give consistent cluster names across datasets,
mean the high-quality tested fit can be reused, and speeds up future analysis.</p>
<p>Please contact us at <a class="reference external" href="mailto:poppunk&#37;&#52;&#48;bacpop&#46;org">poppunk<span>&#64;</span>bacpop<span>&#46;</span>org</a>. We would be happy to add your sketches and
fitted model to our other <a class="reference external" href="https://poppunk.net/pages/databases.html">databases</a>.</p>
<section id="database-contents">
<h2>Database contents<a class="headerlink" href="#database-contents" title="Permalink to this heading">#</a></h2>
<p>A database requires the following files:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.h5</span></code>. The sketch database, a HDF5 file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.dists.pkl</span></code> and <code class="docutils literal notranslate"><span class="pre">.dists.npy</span></code> files. Distances for all vs all samples in the sketch database.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_fit.npz</span></code> and <code class="docutils literal notranslate"><span class="pre">_fit.pkl</span></code> files. Python files which describe the model fit.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_graph.gt</span></code>. The network relating distances, fit and strain assignment for all samples in the sketch database.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_clusters.csv</span></code>. The strain assignment of all samples in the sketch database.</p></li>
</ul>
<p>If you used a <a class="reference internal" href="model_fitting.html#lineage-fit"><span class="std std-ref">lineage</span></a> you will also need:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">rank_k_fit.npz</span></code>. Distances for each rank <span class="math notranslate nohighlight">\(k\)</span> fit.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_lineages.csv</span></code>. Combined lineage assignments for each rank.</p></li>
</ul>
<p>You may also have <code class="docutils literal notranslate"><span class="pre">.refs</span></code> versions of these files, which are pruned to contain just the
reference samples (see below). We would highly recommend including the <code class="docutils literal notranslate"><span class="pre">output/output.refs</span></code> file
with any database, even though it is not strictly required, as it will speed up query assignment.
Lineage models do not use references.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the database is very large, you may consider just distributing the <code class="docutils literal notranslate"><span class="pre">.refs</span></code> files. This will
enable query assignment, but visualisation and subclustering within strains will no longer be
possible, as full information within each strain will be missing.</p>
</div>
<p>These databases can be automatically generated using the <code class="docutils literal notranslate"><span class="pre">poppunk_distribute_fit.py</span></code>
script after model fitting. See the <a class="reference internal" href="scripts.html"><span class="doc">Scripts</span></a> page for more information.</p>
</section>
<section id="picking-references">
<h2>Picking references<a class="headerlink" href="#picking-references" title="Permalink to this heading">#</a></h2>
<p>PopPUNK automatically prunes redundant sequence information from databases by removing
samples from cliques (where every sample is in the same strain as every other sample). This
algorithm has changed slightly from the originally published one:</p>
<ol class="arabic simple">
<li><p>Split the graph into connected components (strains), which are analysed in parallel.</p></li>
<li><p>Identify a clique. If no samples in the clique are already references, add one sample as a reference.</p></li>
<li><p>Prune the clique from the graph, creating a subgraph.</p></li>
<li><p>Recursively apply steps 2-3 until only two samples or fewer remain.</p></li>
<li><p>Add the remaining samples as references</p></li>
<li><p>Create the reference graph, and find connected components again.</p></li>
<li><p>For any samples which are no longer in the same connected component, find a minimum path
between them in the full graph, and add all samples in this path as references.</p></li>
</ol>
<p>This makes the algorithm scale better, and ensures clusters remain connected. You may find
that more references are picked than before using this method, which is a small cost for the
increase robustness.</p>
<p>This process occurs automatically after the model fit. In the <em>Listeria</em> example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Removing</span> <span class="mi">97</span> <span class="n">sequences</span>
</pre></div>
</div>
<p>31 strains are represented by <span class="math notranslate nohighlight">\(128 - 97 = 31\)</span> references, exactly one reference
per cluster, which is the minimum. The refined fit removes 93 sequences with 29 strains,
so some larger clusters need to be represented by multiple references. The names of the chosen
references are written to the .refs file. In addition, the distances, sketch database and graph
have the non-reference sequences pruned and saved with .refs suffixes. This gives a complete database
suitable for assignment with references only, should the full database be prohibitively large.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Previous fans (users) of PopPUNK may remember the <code class="docutils literal notranslate"><span class="pre">--full-db</span></code> option which switched off
reference picking. This was useful, as reference-only databases always lost information. This
option has now been removed, and reference picking will always be run. Both full and reference
databases are always produced (apart from in lineage mode). The default assignment uses
just references, but has the full database available for strain visualisation and subclustering.</p>
</div>
<p>If you interrupt the reference picking the output will still be valid. If you wish to
run reference picking on a database where it is missing (due to being from an older version,
or interrupted) you can do this with the <code class="docutils literal notranslate"><span class="pre">poppunk_references</span></code> script.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="query_assignment.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Query assignment (<code class="docutils literal notranslate"><span class="pre">poppunk_assign</span></code>)</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="model_fitting.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Fitting new models (<code class="docutils literal notranslate"><span class="pre">--fit-model</span></code>)</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2018-2023, John Lees and Nicholas Croucher
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Distributing PopPUNK models</a><ul>
<li><a class="reference internal" href="#database-contents">Database contents</a></li>
<li><a class="reference internal" href="#picking-references">Picking references</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="./" id="documentation_options" src="_static/documentation_options.js?v=1fc3131f"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="_static/scripts/furo.js?v=32e29ea5"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>